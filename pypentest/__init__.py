"""
__author__ = "Fernando D Minguela"
__copyright__ = "Copyright 2023, Fernando D Minguela"
__license__ = "GPL"
__version__ = "0.0.1"
__maintainer__ = "https://github.com/arkadoel"
__email__ = "https://github.com/arkadoel"
__status__ = "alpha"
"""

import requests 
import pandas as pd
#import os
import json
import time

def extraer_cabeceras(url):
    """Extrae las cabeceras de un sitio y luego analiza cuales hay"""
    print("")
    print(f"Examinando url {url}...")
    print("=================================")

    headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36'}
    response = requests.get(url, headers=headers)


    dict_headers = response.headers.__dict__['_store']
    #json_headers = json.dumps(dict_headers)
    print('Headers = ',response.headers)

    keys = list(key.lower() for key in dict_headers.keys())
    print(f"status code {response.status_code}")
    print("")
    print("Evaluate headers")   
    evaluate_csp(keyslist=keys)
    evaluate_sts(url=url, keyslist=keys)
    generic_evaluate(keylist=keys, evaluate_headers=[
        "X-Xss-Protection",
        "X-Frame-Options",
        "X-Content-Type-Options",
        "Pragma",
        "Expires",
        "Cache-Control"
    ])

    response.close()
    print("")

def evaluate_csp(keyslist):
    """Evalua si hay cabecera CSP"""

    print("\tContent-security-policy ", end="")
    if "content-security-policy" in keyslist or "x-content-security-policy" in keyslist or "x-webkit-csp" in keyslist:
        print("✅")
    else:
        print("❌")

def evaluate_sts(url,keyslist):
    """Evalua si hay cabecera strict transport security cuando se trata de un HTTPS"""
    print("\tStrict-Transport-Security ", end="")

    if "https" in url.lower():
        if "strict-transport-security" in keyslist :
            print("✅")
        else:
            print("❌")
    else:
        print("none https")

def generic_evaluate(keylist, evaluate_headers):
    """Evalua si cabeceras comunes estan en el listado de cabeceras"""
    
    for key in evaluate_headers:
        print("\t" + key + " ", end="")
        if key.lower() in keylist :
            print("✅")
        else:
            print("❌")

if __name__ == '__main__':
    #print(os.getcwd())
    fichero = pd.read_csv("urls-pentest.csv")

    for index, row in fichero.iterrows():
        url = row["url"]
        if url[0] != "#":
            extraer_cabeceras(url)
